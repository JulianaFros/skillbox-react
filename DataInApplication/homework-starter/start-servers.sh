#!/bin/bash

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
lsof -ti:4000 | xargs kill -9 2>/dev/null
lsof -ti:5173 | xargs kill -9 2>/dev/null
pkill -9 -f "tsx|vite" 2>/dev/null
sleep 2

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 4000..."
cd server
nohup npm run dev > ../server.log 2>&1 &
SERVER_PID=$!
cd ..

sleep 3

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if lsof -ti:4000 > /dev/null 2>&1; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $SERVER_PID)"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ server.log"
    exit 1
fi

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç –≤ —Ñ–æ–Ω–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–ª–∏–µ–Ω—Ç –Ω–∞ –ø–æ—Ä—Ç—É 5173..."
cd client
nohup npx vite > ../client.log 2>&1 &
CLIENT_PID=$!
cd ..

sleep 3

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if lsof -ti:5173 > /dev/null 2>&1; then
    echo "‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω (PID: $CLIENT_PID)"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ client.log"
    exit 1
fi

echo ""
echo "üéâ –°–µ—Ä–≤–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã!"
echo "üì° API: http://localhost:4000"
echo "üåê –ö–ª–∏–µ–Ω—Ç: http://localhost:5173"
echo ""
echo "üìù –õ–æ–≥–∏:"
echo "   –°–µ—Ä–≤–µ—Ä: homework-starter/server.log"
echo "   –ö–ª–∏–µ–Ω—Ç: homework-starter/client.log"
echo ""
echo "‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: lsof -ti:4000 -ti:5173 | xargs kill -9"
echo ""
